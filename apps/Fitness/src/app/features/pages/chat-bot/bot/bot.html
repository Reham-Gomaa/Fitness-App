<section id="bot">
    <div
        (click)="openChat()"
        (keydown)="openChat()"
        tabindex="0"
        class="bot-btn flex flex-column justify-content-center align-items-center"
    >
        <img
            ngSrc="/images/bot/bot.avif"
            alt="bot image"
            width="110"
            height="80"
            priority
            ngSrcset="110w"
        />
        <app-main-button
            [fireStartExplore]="'bot'"
            [customClass]="'orange-btn'"
            [fontWeight]="'font-semibold'"
            [btnText]="(isActiveChat() ? 'bot.closeChat' : 'bot.openChat') | translate"
        />
    </div>
    <div
        class="chat-box"
        [class.active]="isActiveChat()"
    >
        <!-- Sidebar -->
        <div
            class="chat-sidebar"
            [class.hidden]="!isSidebarOpen()"
        >
            <div class="sidebar-header">
                <i
                    class="pi pi-plus new-chat-btn cursor-pointer"
                    (click)="resetChat(); toggleSidebar()"
                    (keydown)="resetChat(); toggleSidebar()"
                    tabindex="0"
                    title="New Chat"
                ></i>
                <h4>{{ 'bot.previousConversations' | translate }}</h4>
            </div>

            <div class="conversations-list">
                @for (session of chatHistory(); track session.id) {
                <div
                    class="conversation-item"
                    [class.editing]="editingSessionId() === session.id"
                    (click)="onSessionClick(session)"
                    (keydown)="onSessionClick(session)"
                    tabindex="0"
                >
                    @if (editingSessionId() === session.id) {
                    <div class="edit-mode flex align-items-center w-full">
                        <input
                            type="text"
                            [ngModel]="editingTitle()"
                            (ngModelChange)="editingTitle.set($event)"
                            (click)="$event.stopPropagation()"
                            (keydown.enter)="saveTitle($event)"
                            (keydown.escape)="cancelEditing($event)"
                            class="edit-input"
                            autofocus
                        />
                        <div class="edit-actions flex ml-2">
                            <i
                                class="pi pi-check text-green-500 mr-2 cursor-pointer"
                                (click)="saveTitle($event)"
                                (keydown)="saveTitle($event)"
                                tabindex="0"
                            ></i>
                            <i
                                class="pi pi-times text-red-500 cursor-pointer"
                                (click)="cancelEditing($event)"
                                (keydown)="cancelEditing($event)"
                                tabindex="0"
                            ></i>
                        </div>
                    </div>
                    } @else {
                    <span class="conversation-text">
                        {{ session.title || ('bot.untitledChat' | translate) }}
                    </span>
                    <div class="actions flex">
                        <i
                            class="pi pi-pencil edit-btn mr-2"
                            (click)="startEditingTitle($event, session)"
                            (keydown)="startEditingTitle($event, session)"
                            tabindex="0"
                        ></i>
                        <i
                            class="pi pi-trash delete-btn"
                            (click)="deleteSession(session.id); $event.stopPropagation()"
                            (keydown)="deleteSession(session.id); $event.stopPropagation()"
                            tabindex="0"
                        ></i>
                    </div>
                    }
                </div>
                } @empty {
                <p class="no-conversations">{{ 'bot.noPreviousConversations' | translate }}</p>
                }
            </div>
        </div>
        <div class="chat-nav flex justify-content-between align-items-center">
            <h3 class="my-0">{{ 'bot.smartCoach' | translate }}</h3>
            <i
                class="pi pi-align-right text-lg cursor-pointer"
                (click)="toggleSidebar()"
                (keydown)="toggleSidebar()"
                tabindex="0"
            ></i>
        </div>

        <!-- Overlay -->
        @if (isSidebarOpen()) {
        <div
            class="sidebar-overlay"
            (click)="toggleSidebar()"
            (keydown)="toggleSidebar()"
            tabindex="0"
        ></div>
        }

        <!-- Chat Messages Container -->
        <div
            class="chat-messages"
            #chatContainer
        >
            @for (msg of messages(); track $index) { @if (msg.text) {
            <div
                class="message-bubble"
                [class.user]="msg.role === 'user'"
                [class.model]="msg.role === 'model'"
            >
                {{ msg.text }}
            </div>
            } } @if (isStreaming() && (!messages().length || !messages()[messages().length -
            1].text)) {
            <div class="message-bubble model">
                <span class="loading-dots">●●●</span>
            </div>
            }@else { }
        </div>

        <div class="chat-input flex justify-content-between align-items-center gap-2">
            <div class="card relative flex justify-content-center w-full mr-2">
                <input
                    #chatInput
                    type="text"
                    [placeholder]="'bot.placeholder' | translate"
                    [(ngModel)]="chatMessage"
                    (keydown.enter)="sendMessage()"
                    (focus)="onInputFocus()"
                />
                <i class="pi edit pi-pencil absolute"></i>
            </div>
            <div
                class="send-icon flex align-items-center"
                (click)="isStreaming() ? stopResponse() : sendMessage()"
                (keydown)="isStreaming() ? stopResponse() : sendMessage()"
                tabindex="0"
            >
                @if (isStreaming()) {
                <i class="pi pi-stop-circle text-lg cursor-pointer text-red-500"></i>
                } @else {
                <i class="pi pi-send text-lg cursor-pointer"></i>
                }
            </div>
        </div>
    </div>
</section>
